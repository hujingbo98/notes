<!--
 * @Author : Hu Jingbo
 * @Date   : 2022-01-18
-->

# 游戏服务器

游戏服务器根据不同的游戏类型有很大的区别，如王者荣耀之类的MOBA手游，服务器主要由2部分构成，局内战斗服务器和局外系统服务器。

## 数据同步

服务器需要做到给各个玩家数据同步，也就是说，在一局游戏内，所有玩家的实时状态都要相互可见。这其中又设计到2种技术，帧同步和状态同步。

### 状态同步

状态同步的流程是：客户端上传操作到服务器，由服务器服务器计算游戏逻辑，然后以广播的方式下发游戏中各种状态，客户端收到状态后，更新自己本地的位置、技能、动画等状态。

状态同步因为服务器运算，客户端收到结果会有延迟，一般要做预表现和平滑处理。因此它是一种不严谨的同步，在预表现和平滑处理的过程中，不同玩家屏幕上表现的一致性并不是重要指标，保证结果最终一致即可。因此，状态同步对网络延迟的要求并不高。比如 RPG 游戏，200 ~ 300 ms 的延迟也可以接受，但在 RTS 游戏中，50 ms 的延迟很受伤。

举个移动的例子，在状态同步中，客户端甲操作从 A 点移动到 B 点，但在客户端乙上，甲对象从 A 点移动到了 C 点，然后从 C 点移动到了 B 点。这是因为客户端乙在收到 A 的移动状态时，已经经过了一个延迟，甲对象从 A 点到 C 点的过程称为预表现，从 C 点到 B 点的过程称为平滑处理。预表现可以提高及时性，平滑处理使结果最终一致。

为了更好的游戏体验，可以让客户端做一些本地运算，从而减少服务器同步的频率和数据量。

状态同步多用于回合制、MMORPG 等游戏。

**好处：**

* 安全，因为都是服务器计算，客户端只负责表现层面的功能，不会影响各种判定的结果。

* 网络抖动和丢包是可以接受的，只要最终的结果补发一致。

**缺点：**

* 性能问题，服务器运行完整逻辑成本很大，特别是一些复杂逻辑，例如物理弹道等，因此将部分逻辑放在客户端运算。

* 开发效率低，开发能力要求更高。例如技能开发，如果所以逻辑都在客户端开发就会简单很多，响应也非常及时。如果要设计服务器和客户端同步，就会有很多工作量，特别是一些移位技能，很多逻辑可能还要写两份。

* 延时较高。

为了降低网络延迟，一般会在客户端做预表现作为延时补偿，在一定范围内信任客户端。

**反外挂：**


### 帧同步

帧同步服务器不包含游戏逻辑，就是简单将客户端发送过来的命令转发给其他客户端，比如玩家A执行一个攻击操作，那么玩家A客户端会给服务器发送一个攻击命令，服务器将这个命令同步给局内的其他玩家，至于攻击一下少多少点血，会不会把人打死，服务器不管，全部由客户端完成计算判断，客户端计算完毕后将结果发送给服务器，服务器再将结果同步给其他玩家，然后客户端播放表现效果。简单的说帧同步服务器就是给各个游戏客户端同步数据，它会不间断的发，即使局内的玩家什么都不干，傻傻的站在那里，服务器也会发，他的作用就是同步玩家们的状态，所以说帧同步服务器费流量。

动作、MOBA

每个客户端都计算了完整逻辑

帧同步指的是 LockStep，是指服务器按帧转发客户端的操作。

**缺点：**

帧同步难以做预表现，所以对网络和延迟要求更高，必须在网络层上有更深度极致的优化（一些状态同步的游戏网络优化一般，可以通过预表现蒙混过关）。

* 帧同步对网络的要求更加苛刻，下发的序列是不允许乱序和丢包的，如果丢包，必须要等到丢的包到达之后才能顺序往下执行。

**反外挂：**

每个客户端都计算了完整逻辑，作弊玩家只能修改本地数据，无法影响其他玩家。最终结果服务器只要简单对比投票就可以找到作弊者，另外也可以在游戏运行时不断生成关键数据的 hash 码校验。

基于 P2P 的多人 PVP，无法防止主机作弊，参考魔兽争霸，网游基本上不会使用。

帧同步因为天然的客户端强一致性，在防外挂上更简单一些，比如王者荣耀。但无法防止全图挂，因此甚至有 MOBA 游戏，同时使用两种同步机制来保证线上赛和线下赛的公平和体验。

### 状态同步和帧同步怎么选？

**使用状态同步和帧同步的案例：**

游戏类型/同步方案|状态同步|帧同步
:-|:-|:-
FPS|DOOM|CSGO、守望先锋、逆战、绝地求生
MOBA|王者荣耀、DOTA、英雄战境|全面超神、LOL、DOTA2
FGT、ACT|街霸|怪物猎人
RTS|星际争霸、魔兽争霸|
MMO|全民斗战神|魔兽世界、轩辕传奇、天涯明月刀
RAC||QQ 飞车
其它|街机、主机模拟器、刀塔传奇、剑与家园|各种类型都有

大量玩家战斗的游戏只能使用状态同步



