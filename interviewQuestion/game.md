<!--
 * @Author : Hu Jingbo
 * @Date   : 2022-01-07
-->

[toc]

# 游戏

## 服务器

### 游戏服务器和普通后台服务器区别在哪？

游戏服务器的复杂度要大于普通的后台服务器。普通后台服务器的重点在于高并发和最终一致性，而游戏服务器除了这些还需要保证各玩家的数据同步和高及时性。

游戏服务器根据不同的游戏类型有很大的区别，常见的有卡牌游戏、王者荣耀之类的 MOBA 手游。

MOBA 类手游服务器主要由局内战斗服务器和局外系统服务器组成。局内战斗服务器是游戏服务器特有的，互联网 App 服务器没有这样的使用场景。战斗服务器需要同步各个玩家的数据，在一局游戏中，所有玩家的实时状态都要相互可见，并且要保证准确、一致、高及时性。

数据同步一般有两种方法，分别是状态同步和帧同步。

状态同步的流程是：客户端上传操作到服务器，服务器收到后计算游戏行为结果，即游戏逻辑，然后以广播的方式下发游戏中各种状态，客户端收到状态后，更新自己本地的位置、技能、动画等状态。有时为了更好的游戏体验，需要减少同步的数据量，客户端也会做一些本地运算，减少服务器同步的频率和数据量。状态同步多用于回合制、MMORPG 等游戏。

帧同步服务器一般不包含游戏逻辑，就是将客户端发送过来的命令转发给其它客户端。也就是说，局内的运算都是在客户端，每个玩家各自算一份，有相同的起始数据、相同的输入、相同的逻辑运算、并且不存在随机过程，这样运算的结果理论上应该是一致的。但浮点数精度问题是一个难点，一般的解决办法是浮点数整形化。

另外还需要处理网络抖动、丢包和弱网问题。普通的互联网服务器，在弱网环境下卡一下没关系。但游戏服务器卡顿、掉帧是致命的，所以一定要处理弱网问题，常用的手段是采用可靠的 UDP、

弱网影响玩家体验是不可避免的，但需要保证在弱网情况下是可以玩的，并且必须保证数据的正确性和最终一致性。

弱网分为三种情况：

1. 频繁断网。通过客户端在一段时间没有数据交互后，定时发送心跳，根据服务器回复的心跳包来判断是否断网，然后进行重连。另外通过这次心跳检测，客户端可以计算出当前的网络延时。同样，服务器也可以记录客户端的最后一次请求时间，当一段时间没收到来自客户端的请求，或者收到来自客户端的同一个玩家的重连请求后，断开之前的连接。

2. 高丢包、误码。通常情况下，TCP 是可靠的，如果在网络传输过程中，TCP 发生了丢包或者误码，底层会自动重新发送。应用层收到的 TCP 包应该是正确的。但仍然有极低的概率发生丢包、内核缓冲区丢失或污染等情况。丢包问题，可以通过客户端多次定时重发请求来确保不会丢包，类似于在应用层实现超时重传和消息确认等机制。但丢包会影响客户端掉帧，可以通过冗余下发来解决丢包造成的掉帧现象。误码问题，我们可以在服务器对收到的请求进行校验，确认请求的正确性后再处理。这时，如果服务器重复处理，会引起数据异常，所以还要进行丢弃重复正确报文段的处理，这里需要在应用层实现类似于 TCP 的序号机制。

3. 高延时

### 游戏服务器有哪些经典架构？

### 你玩过的游戏中有去了解过他们的游戏服务器设计吗？

### 如果要实现跨平台的数据同步你有什么想法

### 玩过lol或者王者荣耀吧 怎么去设计对战服务器 要非常非常详细的设计

### fps游戏中，A向B射出子弹，你能不能描述下这个过程？（生成子弹、碰撞触发blabla）

碰撞触发这个计算在客户端上计算合理吗？（不合理，如果可以外挂开发起来就太容易了）

放在服务器上计算，会有什么问题吗？（没想明白要问什么）

比如给定一个场景，A和B贴脸了，A发射子弹，A肯定会命中B，如果按照常理这个子弹经过计算会在t时间命中B，然而网络延迟高导致包到达的时间在这个t之后，这个时候要怎么处理？涉及到两个问题，一是如何在包延迟的时候仍然判断得出来子弹命中，二是算出来应该命中了要不要让这个事情再发生，也就是顾及A的体验还是B的体验？
