<!--
 * @Author : Hu Jingbo
 * @Date   : 2021-11-06
-->

# 网际协议 (IP)

IP (Internet Protocol) 是 TCP/IP 协议族中最为核心的协议。所有的 TCP、UDP、ICMP 及 IGMP 数据都以 IP 数据报格式传输。IP 提供不可靠、无连接的数据报传输服务。

不可靠 (unreliable) 的意思是它不能保证 IP 数据报能成功地到达目的地。IP 仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP 有一个简单的错误处理算法：丢弃该数据报，然后发送 ICMP 消息报给信源端。任何要求的可靠性必须由上层来提供（如 TCP）。

无连接 (connectionless) 这个术语的意思是 IP 并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明，IP 数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是 A，然后是 B），每个数据报都是独立地进行路由选择，可能选择不同的路线，因此 B 可能在 A 到达之前先到达。

## IP 首部

```txt
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                    Example Internet Datagram Header
```

分析图中的首部。最高位在左边，记为 0 bit；最低位在右边，记为 31 bit。4 个字节的 32 bit 值以下面的次序传输：首先是 0～7 bit，其次 8~15 bit，然后 16~23 bit，最后是 24~31 bit。这种传输次序称作大端字节序 (big endian byte order)。由于 TCP/IP 首部中所有的二进制整数在网络中传输时都要求以这种次序，因此它又称作网络字节序。以其他形式存储二进制整数的机器，如 little endian 格式，则必须在传输数据之前把首部转换成网络字节序。

* Version: 4 位协议版本号
协议版本号为 4 表示 IPv4，6 表示 IPv6。

* IHL: 4 位首部长度 (Internet Header Length) 
首部长度是指首部占 32 位字的数目，包括任何选项。因为它是一个 4 比特字段，因此它的取值范围是 5 ~ 15 (20 ~ 60 Byte)。

* Type of Service: 8 位服务类型字段
TOS 包括 3 bit 的优先级字段，4 bit TOS 子字段和 1 bit 未用位但必须置 0。4 bit 的 TOS 分别代表：最小时延、最大吞吐量、最高可靠性和最小费用。

* Total Length: 16 位总长度字段
总长度字段指 IP 数据报的长度，以字节为单位。利用首部长度字段和总长度字段，我们可以知道 IP 数据报中数据的起始位置和长度。由于该字段为 16 bit，所以 IP 数据报最长可达 65535 字节，但会受 MTU 的限制。

*   