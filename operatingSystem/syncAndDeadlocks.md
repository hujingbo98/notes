<!--
 * @Author : Hu Jingbo
 * @Date   : 2021-11-19
-->

## 进程同步

进程同步是指控制进程按照一定顺序执行，只有处于临界区的进程才需要同步，因此，若能保证诸进程互斥地进入自己的临界区，便可实现诸进程对临界资源的互斥访问。

### 临界资源和临界区

许多硬件资源如打印机、磁带机等，都属于临界资源，多进程间采用互斥方式，实现对这种资源的共享。

多个进程必须互斥地访问临界资源，把在每个进程中访问临界资源的那段代码称为临界区 (critical section)。

### 同步机制应遵循的规则

(1) 空闲让进。当无进程处于临界区时，表明临界资源处于空闲状态，应允许一个请求进入临界区的进程立即进入自己的临界区，以有效地利用临界资源。

(2) 忙则等待。当已有进程进入临界区时，表明临界资源正在被访问，因而其它试图进入临界区的进程必须等待，以保证对临界资源的互斥访问。

(3) 有限等待。对要求访问临界资源的进程，应保证在有限时间内能进入自己的临界区，以免陷入“死等”状态。

(4) 让权等待。当进程不能进入自己的临界区时，应立即释放处理机，以免进程陷入“忙等”状态。

### 自旋锁

当某个变量不满足条件时，会一直轮询直到变量值发送改变。用于忙等待的锁称为自旋锁。自旋锁一般用于中断处理程序中（需要禁止本地中断），因为中断程序需要安全、快速的执行，不能被打断、也不能被睡眠。

### 信号量机制

信号量是一个整型变量，用来实现计数器功能，主要提供 down 和 up 操作（即 P 和 V 操作），这两个操作都是原子性的。当执行 down 操作使信号量值变为 0 时，会导致当前进程睡眠，而执行 up 操作 +1 时，会同时唤醒进程。

### 管程机制

管程是由一个过程、变量和数据结构组成的一个集合，把需要控制的那部分代码独立出来执行，它有一个重要的特性，同一时刻在管程中只能有一个活跃的进程。为了避免一个进程一直占用管程，引入了条件变量和 wait 和 signal 操作。当发生当前进程无法运行时，执行 wait 操作，将当前进程阻塞，同时调入在管程外等待的另一进程执行，而另一个进程满足条件变量时，会执行 signal 操作将正在睡眠的进程唤醒，然后马上退出管程。

### 生产者-消费者问题

生产者-消费者 (producer-consumer) 问题是一个著名的同步问题，它的描述是：有一群生产者在生产产品，并将这些产品提供给消费者消费。

为了能使生产者和消费者并发执行，在两者之间设置了一个缓冲区，生产者将其所生产的产品放入到缓冲区中，消费者从缓冲区中取走产品去消费。尽管生产者和消费者都是以异步方式运行的，但它们之间必须保持同步，既不允许消费者到一个空的缓冲区去取产品，也不允许生产者向一个已装满产品且尚未被取走的缓冲区中投放产品。

我们可以引入一个整形变量 counter 进行计数，其初始值为 0。每当生产者向缓冲区中投放一个产品后，使 counter 加 1，每当消费者从缓冲区中取走一个产品后，使 counter 减 1。

对 counter 进行加 1 操作在机器语言实现时，先将内存中的 counter 复制到寄存器中，然后将寄存器的值加 1，最后将寄存区的值回写到内存中的 counter。

假设 counter 的当前值是 0，两个生产者同时投放产品，则可能会出现下面现象：

```txt
register1 = counter         (register1 = 0)
register1 = register + 1    (register1 = 1)
register2 = counter         (register2 = 0)
register2 = register + 1    (register2 = 1)
counter = register1         (counter = 1)
counter = register2         (counter = 1)
```

正确的 counter 值应当是 2，但现在是 1。消费者也会遇到同理错误，为防止这种错误，应把变量 counter 作为临界资源处理，即令生产者和消费者互斥地访问变量 counter。

可以使用信号量和管程来解决此问题。

### 哲学家进餐问题

五个哲学家围着一张圆桌，每个哲学家面前放着食物，左右两边各放着一只筷子。哲学家的生活有两种交替活动：进餐以及思考。当一个哲学家进餐时，需要先拿起自己左右两边的筷子，并且一次只能拿起一只筷子。

五个哲学家最多只能同时两个人进餐，因为只有 5 只筷子。如果五个哲学家同时拿起左边的筷子，那么都在等待邻居放下右边的筷子，导致谁都无法进餐，产生死锁。

为了避免死锁，可采取以下几种解决办法：

(1) 当哲学家饥饿时，总是先去拿他左边的筷子，至多只允许四位哲学家同时去那左边的筷子，最终能保证至少一位哲学家能够进餐。

(2) 仅当哲学家的左、右两只筷子均可用时，才允许他拿起筷子进餐。

(3) 对哲学家进行拍号，规定奇数号哲学家先拿起左边的筷子，偶数号哲学家先拿起右边的筷子，最后总会有哲学家能够进餐。

### 读者-写者问题

允许多个进程同时对数据进行读操作，但是不允许读和写以及写和写操作同时发生。

一个整型变量 count 记录在对数据进行读操作的进程数量，一个互斥量 count_mutex 用于对 count 加锁，一个互斥量 data_mutex 用于对读写的数据加锁。
