[toc]

# 操作系统

## 操作系统概述

操作系统 (Operating System, OS) 是管理计算机硬件与软件资源的计算机程序。提供一个计算机用户与计算机硬件系统之间的接口。向上对用户程序提供接口，向下接管硬件资源。操作系统本质上也是一个软件，作为最接近硬件的系统软件，负责处理器管理、存储器管理、设备管理、文件管理和提供用户接口。

`用户 <==> 应用程序 <==> 操作系统 <==> 硬件`

操作系统常规可分为批处理操作系统、分时操作系统和实时操作系统。若一个操作系统兼顾批处理和分时功能，则称为通用操作系统。常见的通用操作系统有：Windows、Linux、MacOS 等。

### 操作系统的基本功能

一般 OS 内核都包含了一下两大方面功能：

1. 支撑功能

(1) 中断处理。中断处理是内个最基本的功能，是整个操作系统活动的基础，OS 中许多重要的活动，如系统调用、键盘命令的输入、进程调度、设备驱动等，都依赖于中断。

(2) 时钟管理。时钟管理是内核的一项基本功能，在 OS 中的许多活动都需要得到它的支撑，如在时间片轮转调度中，每当时间片用完时，便由时钟管理产生一个中断信号，使得调度程序重新进行调度。

(3) 原语操作。所谓原语 (Primitive)，就是由若干条指令组成的，用于完成一定功能的一个过程。它与一遍过程的区别在于，它们是“原语操作 (Action Operation)”。所谓原子操作是指，一个操作中所有动作要么全做，要么全不做。因此，原语在执行过程中不允许中断。

2. 资源管理功能

(1) 进程管理

(2) 存储器管理

(3) 设备管理

### 内核态和用户态

为了防止 OS 本身及关键数据 (如 PCB 等) 遭受应用程序有意或无意的破坏，通常将 CPU 的执行状态分为内核态和用户态两种：

(1) 内核态，也称为管态或系统态。它具有较高的特权，能执行一切指令，访问所有寄存器和存储区，传统的 OS 都在内核态运行。

(2) 用户态，又称目态。它是具有较低特权的执行状态，仅能执行规定的指令，访问指定的寄存器和存储区。

一般情况下，应用程序只能在用户态运行，不能去执行 OS 指令及访问 OS 区域，这样可以有效防止应用程序对 OS 进行破坏。

#### 内核态和用户态的切换

处理器从用户态切换到内核态的方法有三种：系统调用、异常和外部中断。

1. 系统调用是操作系统的最小功能单位，是操作系统提供的用户接口，系统调用本身是一种软中断。

2. 异常，也叫做内中断，是由错误引起的，如文件损坏、缺页故障等。

3. 外部中断，是通过两根信号线来通知处理器外设的状态变化，是硬中断。

### 系统调用

系统调用是操作系统的一种保护机制，它提供一系列定义良好的 API 来和操作系统交互，避免用户程序直接对内核进行操作，保证了系统的稳定、安全、可靠。

系统调用是在一个进程中，由用户态切换到内核态，在内核中执行任务，或者申请操作系统的资源。

### 并行与并发

同一个 CPU 在同一时刻只能执行一个指令。

并行 (parallelism) 是指两个或多个事件在同一时刻发生，是严格物理上的同时运行，需要多处理器的支持。

并发 (concurrency) 是指两个或多个事件在同一时间间隔内发生，是宏观上看起来两个程序同时运行，通常是指单核进行时间片轮转和上下文切换造成同时运行的现象。

### C 程序的存储空间布局

* 正文段，也称代码段。这是由 CPU 执行的机器指令部分。通常，正文段是可共享的，所以即使是频繁执行的程序在存储器中也只需要一个副本，另外，正文段常常是只读的，以防止程序由于意外而修改其指令。

* 初始化数据段，通常将此段称为数据段。它包含了程序中明确地赋非 0 初值的全局变量、静态变量。代码段不是只读的，在运行时变量的值是可以改变的。数据段还可细分为初始化只读区和初始化可读写区。

* 未初始化数据段，通常将此段称为 bss 段，这一名字来源于早期汇编程序一个操作符，意思是“由符号开始的块” (block started by symbol)。在程序开始执行之前，它包含了程序中初始化为 0 的和未初始化的全局变量、静态变量，内核将此段中的数据初始化为 0 或空指针。生命周期是整个进程的生命周期的变量都保存在数据段或 bss 段。

* 堆。通常在堆中进行动态内存分配，堆位于 bss 段末尾，并向高地址生长。

* 栈。自动变量以及每次函数调用时所需保存的信息都存放在此段中，栈与对是相邻的，并向对方的方向生长，因此栈的内存地址是从高到低分配的，当栈指针触及到堆指针位置时，意味着堆栈空间已被耗尽。

* 内存映射段。该段保存共享库和共享内存的映射。

```txt
            栈
            内存映射段
            堆
            未初始化数据段 (bss 段)
            初始化数据段
            代码段
```

### 共享库 (动态链接库) 和共享内存

我们知道，动态链接库 (在 Windows 上的后缀为 dll，在 Linux 下的后缀为 so) 采用的是延迟加载机制，即程序在运行的过程中在被调用的时候才会被加载。一个动态库在内存中只存在一份，可以被多个进程共享。这样做很明显可以节省内存空间。

那么问题来了：共享内存在内存中也是只存在一份，也可以被多个进程共享。在不同的进程中，共享的那段内存的被分配的地址会有所不同。那么，同样是在内存中只存在一份，同样是可以被其他进程共享，动态链接库和共享内存的区别在哪呢？

区别就在于：多个程序虽然可以共享同一个动态链接库中的相同代码，但每一个进程都为动态链接库使用的全部数据分配了自己的地址空间。而共享内存是代码和数据均被多个程序所共享。动态链接库只是实现了代码的复用，对于数据，各个程序要自己保存。共享内存用于进程间通信，主要用于数据的内存共享。这也从侧面反映出动态链接库并不能用于实现进程之间通信。
