<!--
 * @Author : Hu Jingbo
 * @Date   : 2021-11-19
-->

# 进程间的通信

## 无名管道

管道是一种最基本的 IPC 机制，作用于有血缘关系的进程之间，它是半双工的，如果要进行双工通信，则需要建立两个管道。

管道是一个伪文件，实为环形队列的内核缓冲区。由两个文件描述符引用，一个表示读端，一个表示写端。规定数据从写端流入，从读端流出。

注意：从管道读数据是一次性操作，数据一旦被读，便被丢弃，释放空间以便写更多的数据。

**管道的局限性：**

1. 只能用于有血缘关系的进程之间。

2. 数据自己读不能自己写。且数据一旦被读走，便被丢弃，不可反复读取。

4. 管道采用半双工通信方式，因此，数据只能在一个方向上流动。如果要进行全双工通信，则需要建立两个管道。

## 命名管道

用于没有血缘关系的进程之间的通信。

## 消息队列

独立于进程存在，进程间可以通过消息队列来传递数据，典型的模式是生产者-消费者模型。

## 信号

信号是软件中断，提供了一种处理异步事件的方法，由系统通知进程发生了某种类型的系统事件。

信号的特点是简单、携带信息量少、优先级高，使用在特定场景。一般不使用信号进行进程间通信，因为信号的优先级会打破原有进程的执行过程。

### 信号的产生条件

很多条件可以产生信号。

* 当用户按某些终端键时，引发终端产生的信号。在终端上按 Ctrl+C 键通常产生终端信号 (SIGINT)。这是停止一个程序的方法。

* 硬件异常产生信号：除数为 0、无效的内存引用等。这些条件通常有硬件检测到，并通知内核。然后内核为该条件发生时正在运行的进程产生适当的信号。例如，对执行一个无效内存引用的进程产生 SIGSEGV 信号。

* 进程调用 kill(2) 函数可将任意信号发送给另一个进程或进程组。自然，对此有所限制：接收信号的信号进程和发送信号进程的所有者必须相同，或发送信号进程的所有者必须是超级用户。

* 用户可用 kill(1) 命令将信号发送给其它进程。此命令只是 kill 函数的接口。常用此命令终止一个失控的后台进程。

* 当检测到某种软件条件已发生，并应将其通知有关进程时也产生信号。这里指的不是硬件产生的条件，而是软件条件。例如 SIGURG (在网络连接上传来的带外的数据)、SIGPIPE (在管道的读进程已终止后，一个进程写此管道) 以及 SIGALRM (进程所设置的定时器已经超时)。

### 信号的处理方式

在某个信号出现时，可以告诉内核按下列 3 中方式之一进行处理：

1. 忽略此信号。有两种信号不能被忽略，他们是 SIGKILL 和 SIGSTOP。这两种信号不能被忽略的原因是：他们向内核提供了使进程终止或停止的可靠方法。另外如果忽略某些由硬件异常产生的信号，如非法内存引用或除以 0，则进程的运行行为是未定义的。

2. 捕捉信号。为做到这一点，要通知内核在某种信号发生时，调用一个用户函数。在用户函数中，可执行用户希望对这种事件进行的处理。注意，不能捕捉 SIGKILL 和 SIGSTOP 信号。

3. 执行系统默认动作。

### 系统如何将一个信号通知到进程？

例如，有两个进程 A、B，A 调用系统调用委托内核发送信号给 B。内核先检查 A 是否有权限发送此信号给 B，如果无权限，则忽略此信号；如果有权限，则设置 B 的 PCB 中的信号域中的对应的信号的位，之后后发送中断请求给 B，这样 B 进程就进入内核态，这时 B 根据信号表捕捉信号，将对应的信号处理函数地址压入用户栈栈顶，然后由内核态转入用户态，由于先弹出信号处理函数的地址，因此先执行信号处理函数，然后再弹栈，才是 B 中断时的状态。

## 信号量

信号量是一个计数器，用来保护临界资源。进程可以读取信号量的值，并对它进行加减操作，多个进程可以通过信号量实现进程同步。

## 共享内存

共享内存使得多个进程可以访问同一块内存空间，多个进程上不同的地址空间可以映射到同一块物理内存上，实现数据的共享。因不涉及数据的拷贝，所以共享内存是最高效的 IPC。但在多个进程并发时，需要通过同步机制保护共享内存的访问。信号量和共享内存通常结合在一起使用，信号量用于同步对共享内存的访问。

## Socket

通过网络实现不同机器上不同进程间的通信。
