<!--
 * @Author : Hu Jingbo
 * @Date   : 2021-11-12
-->

# 线程 (Thread)

在一个进程中会存在多种活动任务，如果只有一个调度来执行这些任务，那么当某个任务被阻塞时，其他任务将得不到执行，因此需要有多个独立调度的单元来使这些任务可以并行的执行，如果建立多个进程，一方面进程的开销比较大，另一方面诸进程间的数据并不共享，为了减少程序在并发执行时所付出的开销，使 OS 具有更好的并发性，操作系统中引入线程。

线程是进程划分的调度单位，是 CPU 调度的基本单位，用于实现进程内部的并发。

## 线程和进程的比较

由于线程具有许多传统进程所具有的特征，所以又称之为轻型进程或进程元。进程相当于只有一个线程的任务。下面从调度性、并发性、系统开销和拥有资源等方面对线程和进程进行比较。

1. 调度的基本单位

在未引入线程的 OS 中，进程是作为独立调度和分派的基本单位，因而进程是能独立运行的基本单位。在每次调度是都需要上下文切换，开销较大。

在引入线程的 OS 中，把线程作为调度和分派的基本单位，因而线程是能独立运行在进程中的基本单位，当线程切换时，仅需要保存和设置少量的寄存器内容，切换代价远低于进程。

2. 并发性

在引入线程的 OS 中，不仅进程之间可以并发执行，而且在一个进程中的多个线程之间亦可并发执行，甚至还允许在一个进程中的所有线程都能并发执行。

3. 拥有资源

进程可以拥有系统资源，并作为系统中拥有资源的一个基本单位。然而，线程本身并不拥有系统资源，而是仅有一点必不可少的、能保证独立运行的资源。比如，在每个线程中的应具有一个用于控制线程运行的线程控制块 TCB、用于指示被执行指令序列的程序计数器、保留局部变量、少数状态参数和返回地址等一组计数器和堆栈。

线程除了拥有自己的少量资源外，还允许多个线程共享该进程所拥有的资源，因为属于同一个进程的所有线程都具有相同的地址空间。

4. 独立性

在同一进程中的不同线程之间的独立性要比不同进程之间的独立性低得多。

这是因为，OS 为防止进程之间彼此干扰和破坏，每个进程都拥有一个独立的地址空间和其它资源，除了共享全局变量外，不允许其它进程访问。

但同一进程中的不同线程往往为了提高并发性以及进行相互之间的合作而创建的，它们共享进程的内存地址空间和资源，如每个线程都可以访问他们所属进程地址空间中的所有地址，如一个线程的堆栈可以被其它线程读、写，甚至完全清楚。由一个线程打开的其它文件可以供其它线程读、写。

5. 系统开销

在创建或撤销进程时，系统都要为之分配和回收 PCB 和其它资源，如内存空间和 I/O 设备等。

OS 为此所付出的开销，明显大于线程创建或撤销时所付出的开销。在 Solaris 2 OS 中，线程的创建要比进程的创建快 30 倍，而线程上下文切换要比进程上下文切换快 5 倍。

6. 支持多处理机系统

在多处理机系统中，对于未引入线程的进程，即单线程进程，不管有多少个处理机，该进程只能运行在一个处理机上。

但对于多线程进程，就可以将一个进程中的多个线程分配到多个处理机上，使它们并行执行，这无疑将加速进程的完成。

## 线程的状态

与进程一样，在各线程之间也存在着共享资源和相互合作的制约关系，致使线程在独立运行时也具有间断性。相应的，线程在运行时也具有以下三种基本状态：

1. 执行状态

2. 就绪状态

3. 阻塞状态

线程状态之间的转换和进程状态之间的转换是一样的。

## TCB

线程控制块 (TCB, Thread Control Block) 通常有以下几项：

1. 线程标识符

2. 一组寄存器，包括程序计数器 PC，状态寄存器和通用寄存器的内容

3. 线程的运行状态

4. 优先级，描述线程执行的优先程度

5. 线程专有存储区，用于线程切换时存放线程保护信息，和与该线程相关的统计信息等

6. 信号屏蔽，即对某些信号进行屏蔽

7. 堆栈指针 (过程调用)